"""
価値観診断 AI要約生成 API サーバー

使い方:
1. pip install -r requirements.txt
2. .env ファイルにAPIキーを設定
3. python server.py
4. ブラウザで http://localhost:5000 を開く
"""

import os
from flask import Flask, request, jsonify, send_from_directory

# .envファイルを読み込む
from dotenv import load_dotenv
load_dotenv()

import anthropic

app = Flask(__name__, static_folder='.')

# 環境変数からAPIキーを取得
API_KEY = os.environ.get('ANTHROPIC_API_KEY')

if not API_KEY:
    print("=" * 50)
    print("⚠️  警告: ANTHROPIC_API_KEY が設定されていません")
    print("   .env ファイルを作成して以下を記述してください:")
    print("   ANTHROPIC_API_KEY=sk-ant-api03-xxxxxxxx")
    print("=" * 50)

# タイプ定義
TYPE_DEFINITIONS = {
    "先導型チャレンジャー": "変化や未知を前向きに受け止め、目標に向かって自ら旗を掲げて突き進むタイプ。",
    "しなやかな推進者": "自らの方向性を示し、人を導く力を持ちながらも柔軟な判断ができるタイプ。",
    "堅実型リーダー": "確立された仕組みを重んじ、長期的な視点で着実な改善を進めるタイプ。",
    "柔軟なチャレンジャー": "変化や挑戦に価値を感じ、チームとの調和も保てるバランスの良い挑戦者。",
    "バランス型アジャスター": "挑戦と安定のどちらにも偏らず、柔軟に役割を果たせるタイプ。",
    "堅実な調整者": "安定感や継続性を大切にし、落ち着いた判断で周りを取りまとめるタイプ。",
    "柔軟型チャレンジャー": "新しい一歩を軽快に感じ、挑戦的なビジョンに共感して支える役回りを得意とするタイプ。",
    "共感的な支え手": "周囲を支える姿勢を大切にし、チームの流れに自然と寄り添う力を持つタイプ。",
    "支援型スタビライザー": "組織や環境の安定を重視し、縁の下の協力者として支え役割にやりがいを感じるタイプ。",
    "構造的イノベーター": "ルールや秩序を大切にしながらも、枠の中で自由な発想を取り入れるタイプ。",
    "構造化された柔軟派": "ルールを大切にしながらも自由な発想を取り入れ、チーム貢献と安心感をもたらすタイプ。",
    "保守的エンジニア": "伝統や過去の知恵を重視し、形式や手順を守りながら確実性のある成果を生むタイプ。",
    "穏やかなアイデア提案者": "新しいアイデアを生み出す力を持ちながら、周囲との調和も大切にするタイプ。",
    "バランス型フレームワーカー": "挑戦と保守、ルールと自由のバランスをとり、柔軟に思考を切り替えられるタイプ。",
    "安定志向の実践者": "過去の成功事例を尊重しながら、守るべきものと変えるべきものの見極めに長けたタイプ。",
    "自由奔放クリエイター": "発想が豊かで固定観念に縛られず、創造性を最も大切にするタイプ。",
    "しなやかな枠超え思考者": "形式にとらわれず自分らしいやり方を大切にし、必要に応じてルールを取り入れるタイプ。",
    "柔軟型トラディショナリスト": "過去の良さや慣習を大切にしながら、自由な発想で解釈・応用することに長けたタイプ。",
    "ストイックパフォーマー": "結果を出すことに強いこだわりを持ち、正攻法で攻める強みがあるタイプ。",
    "信頼される安定派": "約束やルールを守る誠実さを大切にし、状況に応じた柔軟な判断を下せるタイプ。",
    "道義的クラフター": "過程やプロセスの価値を見出し、社会的な意義や誠実な手法を大切にするタイプ。",
    "目的意識のある実行者": "目標達成や成果を意識しながら、状況に応じた行動ができるタイプ。",
    "調和を重んじる現実派": "成果とプロセス、信念と評価のバランスをとり、最適な選択ができるタイプ。",
    "丁寧なクラフター": "努力や取り組みの過程を大切にし、着実で堅実な歩みを進められるタイプ。",
    "成果アピールプレイヤー": "目に見える成果を追求し、認められることでモチベーションが高まるタイプ。",
    "魅せ方に長けた柔軟派": "周囲への注目を意識しながらも、成果や努力を適度にアピールできるタイプ。",
    "共感重視の努力家": "努力の過程を大切にし、仲間との信頼関係の中で力を発揮するタイプ。",
    "オーナーシップ型実行者": "自分の意思で判断・行動し、強い責任感を持つタイプ。",
    "自律した安定型": "責任感を強く持ちながらも、柔軟にスタイルを選べるタイプ。",
    "頼れるチームリーダー": "自分の意思で判断・行動し、リーダー層で力を発揮するタイプ。",
    "独立性ある調整者": "仲間との連携を大切にしつつ、自ら責任を引き受けてやり遂げるタイプ。",
    "柔軟に関わる調整型": "状況や相手に応じて関わり方を柔軟に変えられるタイプ。",
    "協働を活かす安定派": "周囲との連携やチームワークを大切にしながら柔軟な関わりができるタイプ。",
    "独立型コラボレーター": "自分の考えを大切にしながらも、他者との協働にも積極的に取り組むタイプ。",
    "協調性ある柔軟派": "人と協力して価値を生み出すことを重視しながらも柔軟に対応できるタイプ。",
    "共創型サポーター": "チームとの連携を大切に価値を創り上げることに喜びを感じるタイプ。",
    "公明正大な協調者": "組織の一員としての責任を強く意識し、公平性や筋を通す姿勢を持つタイプ。",
    "冷静な調整役": "物事をフラットに見る公平な視点を持ち、感情に左右されず判断できるタイプ。",
    "自律的ジャスティスプレイヤー": "公正さを重視して行動し、平等さと透明性を守る姿勢が信頼を生むタイプ。",
    "つながりを尊ぶ調整者": "チームや組織とのつながりを大切にしつつ柔軟に立ち回れるタイプ。",
    "調和志向の柔軟派": "集団との一体感と個人の自由のバランスよく行動できるタイプ。",
    "自立した協調者": "自分の考えを大切にしながらも、必要なときには協力できるタイプ。",
    "共感的チームプレイヤー": "組織のつながりを重視し、相手の立場に寄り添う姿勢を持つタイプ。",
    "思いやりあるバランサー": "人の気持ちや場の空気に配慮しながら、関係性と自分らしさを大切にするタイプ。",
    "繊細な独立ワーカー": "自分らしさを大切にしながら、他者の感情や関係性を丁寧に扱うタイプ。",
    "即断即決ファイター": "スピード判断を武器に、素早く物事を進めるタイプ。",
    "柔軟に動ける実務派": "自分の判断で物事を進める裁量を好み、状況に応じた実務的なアプローチができるタイプ。",
    "緻密なクラフトマスター": "自らの判断で進めながらも、一つひとつの作業を丁寧に仕上げるタイプ。",
    "スピード重視の調整役": "素早い対応や効率を意識しながらも、場に応じて柔軟な進め方ができるタイプ。",
    "状況対応型オペレーター": "速さと慎重さのバランスをとり、最適な進め方ができるタイプ。",
    "確実性を重んじる支援者": "丁寧に物事を進める姿勢を大切にし、品質や信頼性を意識するタイプ。",
    "スピード実行フォロワー": "行動は素早く、明確なルールや方針にしたがって動くことを好むタイプ。",
    "安定志向のフォロワー": "組織の方針や手順を大切にしながら、場面に応じた柔軟な進め方ができるタイプ。",
    "几帳面な仕組み実行者": "決められた手順で丁寧に遂行し、信頼性の高い作業やルーティンに強いタイプ。",
    "合理的マーケット志向": "顧客ニーズや市場動向を冷静に分析し、論理的な根拠に基づいて意思決定を行うタイプ。",
    "論理的な調整型": "データや事実に基づいて冷静に判断し、柔軟に視点を切り替えられるタイプ。",
    "ロジカルプランナー": "組織全体の視点を重視し、データや論理的根拠に基づいて判断するタイプ。",
    "対話を大切にする現場感覚派": "顧客や現場の声を重視しながら、状況に応じて多角的に判断できるタイプ。",
    "視座柔軟型バランサー": "顧客と組織、感情と分析のどちらにも偏らず柔軟に使い分けられるタイプ。",
    "全体最適を考える安定型": "組織全体のルールや方針を意識しながら、柔軟に対応できるタイプ。",
    "共感型サービスマインド": "顧客の立場や気持ちに共感し、ホスピタリティに優れたタイプ。",
    "共感力ある柔軟派": "人の気持ちや空気感を感じ取りながら判断し、柔軟な対応ができるタイプ。",
    "人間関係重視の組織人": "組織内の関係性や感情の流れを重視し、人の気持ちに寄り添って動くタイプ。",
    "成果還元型プロフェッショナル": "貢献する姿勢を持ちながらも、努力に見合った報酬をきちんと求めるタイプ。",
    "成果重視の現実派": "仕事において報酬や待遇を重視しながらも柔軟に行動できるタイプ。",
    "成果志向のセルフプレイヤー": "自分の裁量で物事を進め、成果を収入という形で確実に得ることに価値を置くタイプ。",
    "他者志向のバランス型": "周囲への貢献やサポートを意識しながら、状況に応じて柔軟に価値判断ができるタイプ。",
    "動機の多様性を受け入れる柔軟型": "収入と意義、他者貢献と自己完結のいずれにも偏らず柔軟に切り替えられるタイプ。",
    "自律志向の柔軟派": "自分の内なる価値観に従って行動し、意味のある仕事にこだわるタイプ。",
    "理想駆動型ミッションワーカー": "社会的意義や理念に突き動かされ、貢献しようとする使命感の強いタイプ。",
    "やりがい重視の柔軟派": "仕事を通じて意義や意味を感じることを重視し、自然体で選べるタイプ。",
    "信念追求型クリエイター": "自分の内なる価値観に従って行動し、創造性や深い専門性を追求するタイプ。",
    "調和型サポーター": "感情や空気に敏感で、自分を抑えて周囲との調和を重視するタイプ。",
    "気づかい上手な柔軟派": "周囲の感情や空気を察して行動し、状況に応じた振る舞いができるタイプ。",
    "共感的コミュニケーター": "自分の考えを率直に表現しながらも、相手の気持ちにしっかりと配慮できるタイプ。",
    "控えめで調和的な実務派": "自分の意見を控えて行動し、状況に応じた振る舞いができるタイプ。",
    "調和的メッセンジャー": "自己表現と自己抑制のバランスをとり、柔軟に伝え方を切り替えられるタイプ。",
    "自分らしさを活かす柔軟派": "自分の意見を率直に伝える力を持ちながら、場に応じてバランスよく判断できるタイプ。",
    "慎重な理性派ブレイン": "冷静に物事を筋道立てて考え、論理性と客観性を武器にするタイプ。",
    "論理と共感のバランサー": "物事を整理し筋道を立てて考える力を大切にしながら、柔軟に振る舞えるタイプ。",
    "自信ある論理派プッシュ型": "自分の意見を論理的に明快に主張し、納得できる構造と筋道で相手を説得するタイプ。"
}

SYSTEM_PROMPT = """あなたは価値観診断の専門家です。ユーザーから提示された9つの診断結果を受け取り、診断を受けた本人に向けて総合的な価値観プロファイルを作成してください。

【出力ルール】
1. 300〜400文字程度で要約すること
2. 必ず「あなたは〜」という二人称で、診断を受けた本人に直接語りかける表現を使うこと
3. 「この方は」「この人は」「彼/彼女は」などの第三者的な表現は絶対に使わないこと
4. その人の強みや特徴を前向きかつ具体的に表現すること
5. 9つの価値観を統合した一貫性のある人物像を描くこと
6. どのような場面・環境で力を発揮できるかを含めること
7. 箇条書きではなく、読みやすい文章で記述すること

【出力例の書き出し】
✅ 良い例：「あなたは変化を恐れず先頭に立って突き進む推進力を持っています。」
❌ 悪い例：「この方は変化を恐れず先頭に立って突き進む推進力を持っています。」"""


@app.route('/')
def serve_index():
    return send_from_directory('.', 'index.html')


@app.route('/api/generate', methods=['POST'])
def generate_profile():
    if not API_KEY:
        return jsonify({'error': 'APIキーが設定されていません。.envファイルを確認してください。'}), 500
    
    try:
        data = request.get_json()
        diagnosis = data.get('diagnosis', [])
        
        if len(diagnosis) != 9:
            return jsonify({'error': '診断結果が不足しています'}), 400
        
        # ユーザープロンプトを構築
        lines = []
        for i, item in enumerate(diagnosis, 1):
            matrix = item.get('matrix', '')
            type_name = item.get('type', '')
            desc = TYPE_DEFINITIONS.get(type_name, '')
            lines.append(f"{i}. {matrix}: {type_name}")
            if desc:
                lines.append(f"   説明: {desc}")
        
        user_prompt = f"""以下の診断結果から、この人の価値観プロファイルを要約してください。

【診断結果】
{chr(10).join(lines)}"""

        # API呼び出し
        client = anthropic.Anthropic(api_key=API_KEY)
        
        message = client.messages.create(
            model="claude-3-5-haiku-20241022",
            max_tokens=1000,
            system=SYSTEM_PROMPT,
            messages=[{"role": "user", "content": user_prompt}]
        )
        
        profile = message.content[0].text
        
        return jsonify({'profile': profile})
        
    except anthropic.AuthenticationError:
        return jsonify({'error': 'APIキーが無効です'}), 401
    except anthropic.RateLimitError:
        return jsonify({'error': 'APIレート制限に達しました。しばらく待ってから再試行してください'}), 429
    except Exception as e:
        return jsonify({'error': str(e)}), 500


if __name__ == '__main__':
    print("=" * 50)
    print("価値観診断 AI要約テスト サーバー")
    print("=" * 50)
    print(f"URL: http://localhost:5000")
    print("Ctrl+C で終了")
    print("=" * 50)
    app.run(debug=True, port=5000)
